<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">scripts/modules/ListFormatter.js | typester</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Typester">Typester</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#config">config</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-formatters">formatters</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Toolbar">Toolbar</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#containers">containers</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AppContainer">AppContainer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CanvasContainer">CanvasContainer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-FormatterContainer">FormatterContainer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-UIContainer">UIContainer</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core">core</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Container">Container</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Context">Context</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Mediator">Mediator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Module">Module</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules">modules</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BaseFormatter">BaseFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BlockFormatter">BlockFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Canvas">Canvas</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ContentEditable">ContentEditable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Flyout">Flyout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Formatter">Formatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LinkFormatter">LinkFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ListFormatter">ListFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Mouse">Mouse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Paste">Paste</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Selection">Selection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TextFormatter">TextFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Toolbar">Toolbar</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-guid">guid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DOM">DOM</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-browser">browser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-commands">commands</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-func">func</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-keycodes">keycodes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-pasteUtils">pasteUtils</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-zeroWidthSpace">zeroWidthSpace</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">scripts/modules/ListFormatter.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// jshint strict: false

import Module from &apos;../core/Module&apos;;
import commands from &apos;../utils/commands&apos;;
import DOM from &apos;../utils/DOM&apos;;

/**
* @access protected
*/
const ListFormatter = Module({
    name: &apos;ListFormatter&apos;,
    props: {},
    dom: {},
    handlers: {
        requests: {},
        commands: {
            &apos;format:list&apos;: &apos;formatList&apos;,
            &apos;format:list:cleanup&apos;: &apos;cleanupListDOM&apos;
        },
        events: {
            &apos;contenteditable:tab:down&apos;: &apos;handleTabDown&apos;,
            &apos;contenteditable:tab:up&apos;: &apos;handleTabUp&apos;
        }
    },
    methods: {
        init () {},
        formatList (opts) {
            this.preProcess(opts);
            this.process(opts);
            this.commit(opts);
        },

        preProcess () {
            const { mediator } = this;
            mediator.exec(&apos;format:export:to:canvas&apos;);
        },

        process (opts) {
            const { mediator } = this;
            const canvasDoc = mediator.get(&apos;canvas:document&apos;);
            let toggle = false;

            mediator.exec(&apos;canvas:cache:selection&apos;);
            switch (opts.style) {
            case &apos;ordered&apos;:
                toggle = mediator.get(&apos;selection:in:or:contains&apos;, [&apos;OL&apos;]);
                if (toggle) {
                    // this.prepListItemsForToggle();
                    // while (mediator.get(&apos;canvas:selection:in:or:contains&apos;, [&apos;OL&apos;])) {
                    //     commands.exec(&apos;outdent&apos;, null, canvasDoc);
                    // }
                    // commands.exec(&apos;insertOrderedList&apos;, null, canvasDoc);
                    // return;
                } else if (mediator.get(&apos;selection:in:or:contains&apos;, [&apos;UL&apos;])) {
                    commands.exec(&apos;insertUnorderedList&apos;, null, canvasDoc);
                }
                commands.exec(&apos;insertOrderedList&apos;, null, canvasDoc);
                break;
            case &apos;unordered&apos;:
                toggle = mediator.get(&apos;selection:in:or:contains&apos;, [&apos;UL&apos;]);
                if (toggle) {
                    // this.prepListItemsForToggle();
                    // while (mediator.get(&apos;canvas:selection:in:or:contains&apos;, [&apos;UL&apos;])) {
                    //     commands.exec(&apos;outdent&apos;, null, canvasDoc);
                    // }
                    // commands.exec(&apos;insertUnorderedList&apos;, null, canvasDoc);
                    // return;
                }
                if (mediator.get(&apos;selection:in:or:contains&apos;, [&apos;OL&apos;])) {
                    commands.exec(&apos;insertOrderedList&apos;, null, canvasDoc);
                }
                commands.exec(&apos;insertUnorderedList&apos;, null, canvasDoc);
                break;
            case &apos;outdent&apos;:
                commands.exec(&apos;outdent&apos;, null, canvasDoc);
                break;
            case &apos;indent&apos;:
                commands.exec(&apos;indent&apos;, null, canvasDoc);
                break;
            }

            if (toggle) {
                // mediator.exec(&apos;canvas:select:cachedSelection&apos;);
                this.postProcessToggle(opts);
            } else {
                mediator.exec(&apos;canvas:select:ensure:offsets&apos;);
            }

            // mediator.exec(&apos;canvas:select:cachedSelection&apos;);
        },

        commit () {
            const { mediator, cleanupListDOM } = this;
            mediator.exec(&apos;format:import:from:canvas&apos;, {
                importFilter: cleanupListDOM
            });
        },

        handleTabDown (evnt) {
            const { mediator } = this;
            const isInList = mediator.get(&apos;selection:in:or:contains&apos;, [&apos;UL&apos;, &apos;OL&apos;]);

            if (isInList) {
                evnt.preventDefault();
            }
        },

        handleTabUp (evnt) {
            const { mediator } = this;
            const isInList = mediator.get(&apos;selection:in:or:contains&apos;, [&apos;UL&apos;, &apos;OL&apos;]);


            if (isInList) {
                evnt.preventDefault();

                if (evnt.shiftKey) {
                    // this.formatList({ style: &apos;outdent&apos; });
                } else {
                    // this.formatList({ style: &apos;indent&apos; });
                }
            }
        },

        prepListItemsForToggle () {
            const { mediator } = this;

            const canvasDoc = mediator.get(&apos;canvas:document&apos;);
            const canvasBody = mediator.get(&apos;canvas:body&apos;);

            const {
                anchorNode,
                focusNode,
            } = mediator.get(&apos;canvas:selection&apos;);

            const anchorLiNode = DOM.getClosest(anchorNode, &apos;LI&apos;, canvasBody);
            const focusLiNode = DOM.getClosest(focusNode, &apos;LI&apos;, canvasBody);

            mediator.exec(&apos;canvas:cache:selection&apos;);

            let selectedLiNodes = [anchorLiNode];
            let nextLiNode = anchorLiNode.nextSibling;
            while (nextLiNode &amp;&amp; nextLiNode !== focusLiNode) {
                selectedLiNodes.push(nextLiNode);
                nextLiNode = nextLiNode.nextSibling;
            }
            selectedLiNodes.push(focusLiNode);

            selectedLiNodes.forEach((selectedLiNode) =&gt; {
                let contentWrapper = canvasDoc.createElement(&apos;span&apos;);
                selectedLiNode.appendChild(contentWrapper);
                while (selectedLiNode.firstChild !== contentWrapper) {
                    contentWrapper.appendChild(selectedLiNode.firstChild);
                }
            });

            mediator.exec(&apos;canvas:select:cachedSelection&apos;);

            return;
            // const canvasBody = mediator.get(&apos;canvas:body&apos;);
            // const canvasDoc = mediator.get(&apos;canvas:document&apos;);
            //
            // let rootBlock = anchorNode;
            // while(rootBlock.parentNode !== canvasBody) {
            //     rootBlock = rootBlock.parentNode;
            // }
            //
            // const liNodes = rootBlock.querySelectorAll(&apos;li&apos;);
            // liNodes.forEach((liNode) =&gt; {
            //     let pNode = canvasDoc.createElement(&apos;span&apos;);
            //     liNode.appendChild(pNode);
            //     while (liNode.firstChild !== pNode) {
            //         pNode.appendChild(liNode.firstChild);
            //     }
            // });
        },

        postProcessToggle () {
            const { mediator } = this;
            // return;

            const canvasDoc = mediator.get(&apos;canvas:document&apos;);
            const canvasBody = mediator.get(&apos;canvas:body&apos;);

            mediator.exec(&apos;canvas:cache:selection&apos;);

            const {
                anchorNode,
                focusNode
            } = mediator.get(&apos;canvas:selection&apos;);

            const walkToRoot = function (node) {
                let rootNode = node;
                while ( rootNode.parentNode !== canvasBody ) {
                    rootNode = rootNode.parentNode;
                }
                return rootNode;
            };

            const anchorRootNode = walkToRoot(anchorNode);
            const focusRootNode = walkToRoot(focusNode);

            let currentNode = anchorRootNode;
            let currentParagraph;

            const createParagraph = function () {
                currentParagraph = canvasDoc.createElement(&apos;p&apos;);
                DOM.insertBefore(currentParagraph, currentNode);
            };

            const handleBrNode = function (brNode) {
                createParagraph();
                currentNode = brNode.nextSibling;
                DOM.removeNode(brNode);
            };

            const handleDivNode = function (divNode) {
                createParagraph();
                currentNode = divNode.nextSibling;
                while (divNode.firstChild) {
                    currentParagraph.appendChild(divNode.firstChild);
                }
                DOM.removeNode(divNode);
            };

            createParagraph();

            while (currentNode !== focusRootNode) {
                if (currentNode.nodeName === &apos;BR&apos;) {
                    handleBrNode(currentNode);
                } else if (currentNode.nodeName === &apos;DIV&apos;) {
                    handleDivNode(currentNode);
                } else {
                    let orphanedNode = currentNode;
                    currentNode = currentNode.nextSibling;
                    currentParagraph.appendChild(orphanedNode);
                }
            }

            if (focusRootNode.nodeName === &apos;DIV&apos;) {
                handleDivNode(focusRootNode);
            } else {
                currentParagraph.appendChild(focusRootNode);
            }

            mediator.exec(&apos;canvas:select:cachedSelection&apos;);
        },

        cleanupListDOM (rootElem) {
            const listContainers = rootElem.querySelectorAll(&apos;OL, UL&apos;);

            for (let i = listContainers.length - 1; i &gt;= 0; i--) {
                let listContainer = listContainers[i];
                if ([&apos;OL&apos;, &apos;UL&apos;].indexOf(listContainer.parentNode.nodeName) &gt; -1) {
                    if (listContainer.previousSibling) {
                        if (listContainer.previousSibling.nodeName === &apos;LI&apos;) {
                            listContainer.previousSibling.appendChild(listContainer);
                        }

                        if ([&apos;OL&apos;, &apos;UL&apos;].indexOf(listContainer.previousSibling.nodeName) &gt; -1) {
                            for (let j = 0; j &lt;= listContainer.childNodes.length; j++) {
                                listContainer.previousSibling.appendChild(listContainer.childNodes[j]);
                            }
                            DOM.removeNode(listContainer);
                        }
                    } else {
                        DOM.unwrap(listContainer);
                    }
                } else {
                    while (listContainer.parentNode &amp;&amp; listContainer.parentNode !== rootElem &amp;&amp; [&apos;LI&apos;].indexOf(listContainer.parentNode.nodeName) &lt; 0) {
                        DOM.insertBefore(listContainer, listContainer.parentNode);
                    }
                }
            }

            const nestedListItems = rootElem.querySelectorAll(&apos;LI &gt; LI&apos;);
            for (let i = nestedListItems.length - 1; i &gt;= 0; i--) {
                let nestedListItem = nestedListItems[i];
                DOM.insertAfter(nestedListItem, nestedListItem.parentNode);
            }
        }
    }
});

export default ListFormatter;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">scripts/modules/ContentEditable.js | typester</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Typester">Typester</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#config">config</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-formatters">formatters</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Toolbar">Toolbar</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#containers">containers</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AppContainer">AppContainer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CanvasContainer">CanvasContainer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-FormatterContainer">FormatterContainer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-UIContainer">UIContainer</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core">core</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Container">Container</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Context">Context</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Mediator">Mediator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Module">Module</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules">modules</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BaseFormatter">BaseFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BlockFormatter">BlockFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Canvas">Canvas</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ContentEditable">ContentEditable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Flyout">Flyout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Formatter">Formatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LinkFormatter">LinkFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ListFormatter">ListFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Mouse">Mouse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Paste">Paste</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Selection">Selection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TextFormatter">TextFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Toolbar">Toolbar</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-guid">guid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DOM">DOM</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-browser">browser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-commands">commands</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-func">func</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-keycodes">keycodes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-pasteUtils">pasteUtils</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-zeroWidthSpace">zeroWidthSpace</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">scripts/modules/ContentEditable.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// jshint strict: false

import Module from &apos;../core/Module&apos;;
import DOM from &apos;../utils/DOM&apos;;
import keycodes from &apos;../utils/keycodes&apos;;

import contentEditableStyles from &apos;../../styles/contentEditable.scss&apos;;

/**
* @access protected
*/
const ContentEditable = Module({
    name: &apos;ContentEditable&apos;,
    props: {
        styles: null,
        cleanupTimeout: null
    },
    dom: {},
    handlers: {
        requests: {
            &apos;contenteditable:element&apos;: &apos;getContentEditableElement&apos;,
            &apos;contenteditable:toolbar:buttons&apos;: &apos;getToolbarButtons&apos;
        },
        commands: {
            &apos;contenteditable:inserthtml&apos; : &apos;insertHTML&apos;,
            &apos;contenteditable:refocus&apos; : &apos;reFocus&apos;,
            &apos;contenteditable:cleanup&apos; : &apos;cleanup&apos;
        },
        domEvents: {
            &apos;focus&apos; : &apos;handleFocus&apos;,
            &apos;keydown&apos; : &apos;handleKeydown&apos;,
            &apos;keyup&apos; : &apos;handleKeyup&apos;,
            &apos;blur&apos; : &apos;handleBlur&apos;,
            &apos;paste&apos; : &apos;handlePaste&apos;,
            &apos;mouseover&apos; : &apos;handleMouseOver&apos;,
            &apos;mouseout&apos; : &apos;handleMouseOut&apos;,
            &apos;click&apos; : &apos;handleClick&apos;,
            &apos;input&apos; : &apos;handleInput&apos;
        }
    },
    methods: {
        setup () {
            this.appendStyles();
        },

        init () {
            this.ensureClass();
            this.ensureEditable();
            this.updatePlaceholderState();
            this.updateValue();
        },

        appendStyles () {
            const { props } = this;
            props.styles = DOM.addStyles(contentEditableStyles);
        },

        ensureClass () {
            const { dom } = this;
            dom.el[0].classList.add(&apos;typester-content-editable&apos;);
        },

        updatePlaceholderState () {
            const { dom } = this;
            const rootEl = dom.el[0];

            if (rootEl.hasAttribute(&apos;data-placeholder&apos;)) {
                if (
                    (rootEl.childNodes.length &amp;&amp; rootEl.textContent.trim().length)
                ) {
                    rootEl.classList.remove(&apos;show-placeholder&apos;);
                } else {
                    rootEl.classList.add(&apos;show-placeholder&apos;);
                }
            }
        },

        updateValue () {
            const { dom } = this;
            const rootEl = dom.el[0];

            if (rootEl.innerText.trim().length) {
                rootEl.value = rootEl.innerHTML;
            } else {
                rootEl.value = &apos;&apos;;
            }
        },

        ensureEditable () {
            const { dom } = this;
            const rootEl = dom.el[0];

            if (!rootEl.hasAttribute(&apos;contenteditable&apos;)) {
                rootEl.contentEditable = true;
            }
        },

        ensureDefaultBlock () {
            const { dom, mediator } = this;
            const rootEl = dom.el[0];

            if (!/\w+/.test(rootEl.textContent)) {
                rootEl.innerHTML = &apos;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&apos;;
                mediator.exec(&apos;selection:select:contents&apos;, rootEl.childNodes[0]);
            }
        },

        getToolbarButtons () {
            const { dom } = this;
            const { toolbarButtons } = dom.el[0].dataset;
            let buttonArray = [];

            if (toolbarButtons) {
                buttonArray = JSON.parse(toolbarButtons);
            }

            return buttonArray;
        },

        insertHTML (html) {
            const { mediator } = this;

            if (document.queryCommandSupported(&apos;insertHTML&apos;)) {
                document.execCommand(&apos;insertHTML&apos;, null, html);
            } else {
                let currentSelection = mediator.get(&apos;selection:current&apos;);
                let currentRange = mediator.get(&apos;selection:range&apos;);

                currentRange.deleteContents();

                let tmpContainer = document.createElement(&apos;container&apos;);
                tmpContainer.innerHTML = html;

                let docFrag = document.createDocumentFragment();
                let node, lastNode;

                while ((node = tmpContainer.firstChild)) {
                    lastNode = docFrag.appendChild(node);
                }
                currentRange.insertNode(docFrag);

                if (lastNode) {
                    currentRange = currentRange.cloneRange();
                    currentRange.setStartAfter(lastNode);
                    currentRange.collapse(true);
                    currentSelection.removeAllRanges();
                    currentSelection.addRange(currentRange);
                }
            }
        },

        reFocus () {
            const { dom } = this;
            dom.el[0].focus();
        },

        getContentEditableElement () {
            const { dom } = this;
            return dom.el[0];
        },

        cleanup () {
            const { dom, mediator } = this;
            const rootEl = dom.el[0];
            mediator.exec(&apos;format:clean&apos;, rootEl);
        },

        setCleanupTimeout () {
            const { props } = this;
            props.cleanupTimeout = setTimeout(() =&gt; {
                this.cleanup();
            }, 250);
        },

        clearCleanupTimeout () {
            const { props } = this;
            if (props.cleanupTimeout) {
                clearTimeout(props.cleanupTimeout);
                props.cleanupTimeout = null;
            }
        },

        // DOM Event Handlers
        handleFocus () {
            const { mediator } = this;
            this.clearCleanupTimeout();
            this.ensureDefaultBlock();
            this.updatePlaceholderState();
            mediator.emit(&apos;contenteditable:focus&apos;);
        },

        handleKeyup (evnt) {
            const { mediator, dom } = this;
            const keyCode = evnt.which || evnt.keyCode;
            const anchorNode = mediator.get(&apos;selection:anchornode&apos;);

            function CustomEvent(event, params) {
                var evt;
                params = params || { bubbles: true, cancelable: true, detail: undefined };
                evt = document.createEvent(&apos;CustomEvent&apos;);
                evt.initCustomEvent(event, params.bubbles, params.cancelable, params.detail);
                return evt;
            }

            switch (keyCode) {
            case keycodes.ENTER:
                setTimeout(() =&gt; {
                    mediator.emit(&apos;contenteditable:newline&apos;);
                }, 100);
                break;
            case keycodes.BACKSPACE:
                if (!anchorNode.textContent.trim().length || (anchorNode.hasAttribute &amp;&amp; anchorNode.hasAttribute(&apos;contenteditable&apos;))) {
                    mediator.emit(&apos;contenteditable:newline&apos;);
                }
                break;
            case keycodes.TAB:
                mediator.emit(&apos;contenteditable:tab:up&apos;, evnt);
                break;
            }

            dom.el[0].dispatchEvent(new CustomEvent(&apos;change&apos;));

            this.updateValue();
            this.updatePlaceholderState();
        },

        handleKeydown (evnt) {
            const { mediator } = this;
            const keyCode = evnt.which || evnt.keyCode;

            setTimeout(() =&gt; {
                this.updatePlaceholderState();
            }, 25);

            switch (keyCode) {
            case keycodes.TAB:
                mediator.emit(&apos;contenteditable:tab:down&apos;, evnt);
                break;
            }
        },

        handleBlur () {
            const { mediator } = this;
            this.updatePlaceholderState();
            this.updateValue();
            this.setCleanupTimeout();
            mediator.emit(&apos;contenteditable:blur&apos;);
        },

        handlePaste (evnt) {
            const { mediator } = this;
            mediator.emit(&apos;contenteditable:paste&apos;, evnt);
            this.updateValue();
        },

        handleMouseOver (evnt) {
            const { mediator } = this;
            if (evnt.target.nodeName === &apos;A&apos;) {
                mediator.emit(&apos;contenteditable:mouseover:anchor&apos;, evnt);
            }
        },

        handleMouseOut (evnt) {
            const { mediator } = this;
            if (evnt.target.nodeName === &apos;A&apos;) {
                mediator.emit(&apos;contenteditable:mouseout:anchor&apos;, evnt);
            }
        },

        handleClick (evnt) {
            const { dom } = this;
            const rootEl = dom.el[0];

            if (DOM.isIn(evnt.target, &apos;A&apos;, rootEl)) {
                evnt.preventDefault();
                evnt.stopPropagation();
            }
        },

        handleInput () {
            this.updateValue();
        }
    }
});

export default ContentEditable;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>

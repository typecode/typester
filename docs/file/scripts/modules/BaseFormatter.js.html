<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">scripts/modules/BaseFormatter.js | typester</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Typester">Typester</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#config">config</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-formatters">formatters</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Toolbar">Toolbar</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#containers">containers</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AppContainer">AppContainer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CanvasContainer">CanvasContainer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-FormatterContainer">FormatterContainer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-UIContainer">UIContainer</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core">core</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Container">Container</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Context">Context</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Mediator">Mediator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Module">Module</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules">modules</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BaseFormatter">BaseFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BlockFormatter">BlockFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Canvas">Canvas</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ContentEditable">ContentEditable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Flyout">Flyout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Formatter">Formatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LinkFormatter">LinkFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ListFormatter">ListFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Mouse">Mouse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Paste">Paste</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Selection">Selection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TextFormatter">TextFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Toolbar">Toolbar</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-guid">guid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DOM">DOM</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-browser">browser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-commands">commands</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-func">func</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-keycodes">keycodes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-pasteUtils">pasteUtils</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-zeroWidthSpace">zeroWidthSpace</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">scripts/modules/BaseFormatter.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// jshint strict: false

import Module from &apos;../core/Module&apos;;
import commands from &apos;../utils/commands&apos;;
import DOM from &apos;../utils/DOM&apos;;
import zeroWidthSpace from &apos;../utils/zeroWidthSpace&apos;;

import toolbarConfig from &apos;../config/toolbar&apos;;

let validTags = toolbarConfig.getValidTags();
let blockTags = toolbarConfig.getBlockTags();
let listTags  = toolbarConfig.getListTags();

/**
* @access protected
*/
const BaseFormatter = Module({
    name: &apos;BaseFormatter&apos;,
    props: {},
    handlers: {
        requests: {},
        commands: {
            &apos;format:export:to:canvas&apos;: &apos;exportToCanvas&apos;,
            &apos;format:import:from:canvas&apos;: &apos;importFromCanvas&apos;,
            &apos;format:default&apos;: &apos;formatDefault&apos;,
            &apos;format:clean&apos;: &apos;formatClean&apos;
        },
        events: {
            &apos;contenteditable:newline&apos;: &apos;handleNewLine&apos;
        }
    },
    methods: {
        init () {},

        exportToCanvas () {
            const { mediator } = this;
            const rootElement = mediator.get(&apos;selection:rootelement&apos;);
            const canvasBody = mediator.get(&apos;canvas:body&apos;);
            this.injectHooks(rootElement);

            const rangeCoordinates = mediator.get(&apos;selection:range:coordinates&apos;);
            const clonedNodes = this.cloneNodes(rootElement);
            mediator.exec(&apos;canvas:content&apos;, clonedNodes);
            mediator.exec(&apos;canvas:select:by:coordinates&apos;, rangeCoordinates);

            this.removeZeroWidthSpaces(canvasBody);
        },

        cloneNodes (rootElement) {
            let clonedNodes = [];
            rootElement.childNodes.forEach((node) =&gt; {
                clonedNodes.push(node.cloneNode(true));
            });
            return clonedNodes;
        },

        injectHooks (rootElement) {
            while (!/\w+/.test(rootElement.firstChild.textContent)) {
                DOM.removeNode(rootElement.firstChild);
            }

            while(!/\w+/.test(rootElement.lastChild.textContent)) {
                DOM.removeNode(rootElement.lastChild);
            }

            DOM.insertBefore(zeroWidthSpace.get(), rootElement.firstChild);
            DOM.insertAfter(zeroWidthSpace.get(), rootElement.lastChild);
        },

        importFromCanvas (opts={}) {
            const { mediator } = this;
            const canvasBody = mediator.get(&apos;canvas:body&apos;);

            mediator.exec(&apos;canvas:cache:selection&apos;);
            mediator.exec(&apos;format:clean&apos;, canvasBody);
            if (opts.importFilter) {
                opts.importFilter(canvasBody);
            }
            mediator.exec(&apos;canvas:select:cachedSelection&apos;);

            const canvasSelectionCoordinates = mediator.get(&apos;canvas:selection:coordinates&apos;);
            mediator.exec(&apos;selection:select:all&apos;);
            mediator.exec(&apos;contenteditable:inserthtml&apos;, canvasBody.innerHTML);
            mediator.exec(&apos;selection:select:coordinates&apos;, canvasSelectionCoordinates);

            mediator.emit(&apos;import:from:canvas:complete&apos;);
        },

        formatDefault () {
            const { mediator } = this;
            const rootElem = mediator.get(&apos;selection:rootelement&apos;);
            commands.defaultBlockFormat();
            this.removeStyledSpans(rootElem);
        },

        formatEmptyNewLine () {
            const { mediator } = this;
            const anchorNode = mediator.get(&apos;selection:anchornode&apos;);
            const canDefaultNewline = !(anchorNode.innerText &amp;&amp; anchorNode.innerText.trim().length) &amp;&amp; !DOM.isIn(anchorNode, toolbarConfig.preventNewlineDefault);
            const anchorIsContentEditable = anchorNode.hasAttribute &amp;&amp; anchorNode.hasAttribute(&apos;contenteditable&apos;);

            if (canDefaultNewline || anchorIsContentEditable) {
                this.formatDefault();
            }
        },

        formateBlockquoteNewLine () {
            const { mediator } = this;

            commands.exec(&apos;outdent&apos;);
            this.formatDefault();

            const currentRangeClone = mediator.get(&apos;selection:range&apos;).cloneRange();
            const { startContainer } = currentRangeClone;

            if (startContainer.previousSibling &amp;&amp; startContainer.previousSibling.nodeName === &apos;BLOCKQUOTE&apos;) {
                const brEls = startContainer.previousSibling.querySelectorAll(&apos;br&apos;);
                const divEls = startContainer.previousSibling.querySelectorAll(&apos;div&apos;);

                for (let i = 0; i &lt; brEls.length; i++) {
                    DOM.removeNode(brEls[i]);
                }

                for (let i = 0; i &lt; divEls.length; i++) {
                    DOM.unwrap(divEls[i]);
                }

                mediator.exec(&apos;selection:update:range&apos;, currentRangeClone);
            }

        },

        handleNewLine () {
            const { mediator } = this;
            const { startContainer } = mediator.get(&apos;selection:range&apos;);
            const containerIsEmpty = !/\w+/.test(startContainer.textContent);
            const containerIsBlockquote = DOM.isIn(startContainer, &apos;BLOCKQUOTE&apos;);
            const isContentEditable = startContainer.nodeType === Node.ELEMENT_NODE &amp;&amp; startContainer.hasAttribute(&apos;contenteditable&apos;);

            if (containerIsBlockquote) {
                this.formateBlockquoteNewLine();
            } else if (containerIsEmpty || isContentEditable) {
                this.formatEmptyNewLine();
            }
        },

        formatClean (rootElem) {
            this.unwrapInvalidElements(rootElem);
            this.defaultOrphanedTextNodes(rootElem);
            this.removeBrNodes(rootElem);
            this.ensureRootElems(rootElem);
            this.removeStyleAttributes(rootElem);
            this.removeEmptyNodes(rootElem, { recursive: true });

            // -----

            // this.removeBrNodes(rootElem);
            // // this.removeEmptyNodes(rootElem);
            // this.removeFontTags(rootElem);
            // this.removeStyledSpans(rootElem);
            // this.clearEntities(rootElem);
            // this.removeZeroWidthSpaces(rootElem);
            // this.defaultOrphanedTextNodes(rootElem);
            // this.removeEmptyNodes(rootElem, { recursive: true });
        },

        removeStyleAttributes (rootElem) {
            const styleAttributeNodes = rootElem.querySelectorAll(&apos;[style]&apos;);
            styleAttributeNodes.forEach((styleAttributeNode) =&gt; {
                styleAttributeNode.removeAttribute(&apos;style&apos;);
            });
        },

        removeBrNodes (rootElem) {
            const brNodes = rootElem.querySelectorAll(&apos;br&apos;);
            let brNodesToProcess = [];
            let brNodesToRemove = [];

            brNodes.forEach((brNode) =&gt; {
                const skipNode = brNode.skipNode;

                if (skipNode) {
                    return;
                }

                const isLastChild = brNode === brNode.parentNode.lastChild;
                const isDoubleBreak = brNode.nextSibling &amp;&amp; brNode.nextSibling.nodeName === &apos;BR&apos;;
                const isInBlock = DOM.isIn(brNode, blockTags, rootElem);

                if (isLastChild) {
                    brNodesToRemove.push(isLastChild);
                    return;
                }

                if (isDoubleBreak &amp;&amp; isInBlock) {
                    brNodesToProcess.push([
                        brNode,
                        brNode.nextSibling
                    ]);
                    brNode.nextSibling.skipNode = true;
                    return;
                }
            });

            brNodesToProcess.forEach((brNodePair) =&gt; {
                const [firstBrNode, secondBrNode] = brNodePair;
                const closestBlock = DOM.getClosestInArray(firstBrNode, blockTags, rootElem);
                const newParagraph = document.createElement(&apos;p&apos;);
                let previousSibling;

                while ((previousSibling = firstBrNode.previousSibling)) {
                    if (newParagraph.firstChild) {
                        DOM.insertBefore(previousSibling, newParagraph.firstChild);
                    } else {
                        newParagraph.appendChild(previousSibling);
                    }

                    DOM.insertBefore(newParagraph, closestBlock);
                }

                DOM.removeNode(firstBrNode);
                DOM.removeNode(secondBrNode);
            });

            brNodesToRemove.forEach((brNode) =&gt; {
                DOM.removeNode(brNode);
            });
        },

        unwrapInvalidElements (rootElem) {
            const rootDoc = rootElem.ownerDocument;
            const walker = rootDoc.createTreeWalker(
                rootElem,
                NodeFilter.SHOW_ELEMENT,
                null,
                false
            );

            let invalidElements = [];
            while (walker.nextNode()) {
                let { currentNode } = walker;
                let isInvalid = validTags.indexOf(currentNode.nodeName) &lt; 0;
                let isBrNode = currentNode.nodeName === &apos;BR&apos;; // BR nodes are handled elsewhere
                let isTypesterElem = currentNode.className &amp;&amp; /typester/.test(currentNode.className);

                if (isInvalid &amp;&amp; !isBrNode &amp;&amp; !isTypesterElem) {
                    invalidElements.unshift(currentNode);
                }
            }

            invalidElements.forEach((invalidElement) =&gt; {
                let unwrappedNodes = DOM.unwrap(invalidElement, { keepNode: true });
                if (!DOM.isIn(invalidElement, validTags, rootElem) &amp;&amp; unwrappedNodes.length) {
                    let newParagraph = rootDoc.createElement(&apos;p&apos;);
                    unwrappedNodes.forEach((unwrappedNode) =&gt; {
                        newParagraph.appendChild(unwrappedNode);
                    });
                    DOM.insertBefore(newParagraph, invalidElement);
                }
                DOM.removeNode(invalidElement);
            });
        },

        defaultOrphanedTextNodes (rootElem) {
            const { childNodes } = rootElem;
            for (let i = 0; i &lt; childNodes.length; i++) {
                let childNode = childNodes[i];
                if (childNode.nodeType === Node.TEXT_NODE &amp;&amp; /\w+/.test(childNode.textContent)) {
                    let newParagraph = document.createElement(&apos;p&apos;);
                    DOM.insertBefore(newParagraph, childNode);
                    newParagraph.appendChild(childNode);
                    while (newParagraph.nextSibling &amp;&amp; blockTags.concat(listTags).indexOf(newParagraph.nextSibling.nodeName) &lt; 0) {
                        newParagraph.appendChild(newParagraph.nextSibling);
                    }
                }
            }
        },

        clearEntities (rootElem) {
            const rootDoc = rootElem.ownerDocument;
            const walker = rootDoc.createTreeWalker(
                rootElem,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );

            let textNodes = [];
            while(walker.nextNode()) {
                textNodes.push(walker.currentNode);
            }

            textNodes.forEach((textNode) =&gt; {
                if (/\w+/.test(textNode.textContent)) {
                    textNode.nodeValue = textNode.nodeValue.replace(/^\u00a0/, &apos;&apos;);
                    textNode.nodeValue = textNode.nodeValue.replace(/\u00a0$/, &apos;&apos;);
                }
            });
        },

        ensureRootElems (rootElem) {
            const rootNodeTags = [&apos;H1&apos;, &apos;H2&apos;, &apos;H3&apos;, &apos;H4&apos;, &apos;H5&apos;, &apos;H6&apos;, &apos;OL&apos;, &apos;UL&apos;, &apos;BLOCKQUOTE&apos;, &apos;P&apos;];
            const nestableTags = [
                {
                    tags: [&apos;OL&apos;, &apos;UL&apos;],
                    validParents: [&apos;OL&apos;, &apos;UL&apos;, &apos;LI&apos;]
                },
                {
                    tags: [&apos;H1&apos;, &apos;H2&apos;, &apos;H3&apos;, &apos;H4&apos;, &apos;H5&apos;, &apos;H6&apos;],
                    validParents: [&apos;LI&apos;]
                }
            ];
            const rootNodes = rootElem.querySelectorAll(rootNodeTags.join(&apos;, &apos;));
            const validNesting = function (node) {
                let validNesting = false;
                nestableTags.forEach((nestingDict) =&gt; {
                    if (
                        nestingDict.tags.indexOf(node.tagName) &gt; -1 &amp;&amp;
                        nestingDict.validParents.indexOf(node.parentNode.tagName) &gt; -1
                    ) {
                        validNesting = true;
                    }
                });
                return validNesting;
            };

            const moveNodeToRoot = function (node) {
                if (
                    node.parentNode === rootElem
                ) {
                    return;
                }

                if (validNesting(node)) {
                    return;
                }

                let rootParentNode = node.parentNode;
                if (node.tagName === &apos;P&apos; &amp;&amp; [&apos;LI&apos;, &apos;BLOCKQUOTE&apos;].indexOf(rootParentNode.tagName) &gt; -1) {
                    while (node.firstChild) {
                        DOM.insertBefore(node.firstChild, node);
                    }
                    DOM.removeNode(node);
                    return;
                }

                while (
                    rootParentNode.parentNode !== rootElem
                ) {
                    rootParentNode = rootParentNode.parentNode;
                }

                DOM.insertBefore(node, rootParentNode);
            };

            rootNodes.forEach(moveNodeToRoot);
        },

        removeZeroWidthSpaces (rootElem) {
            rootElem.childNodes.forEach((childNode) =&gt; {
                if (
                    childNode.nodeType === Node.TEXT_NODE &amp;&amp;
                    zeroWidthSpace.assert(childNode)
                ) {
                    DOM.removeNode(childNode);
                }
            });
        },

        removeEmptyNodes (rootElem, opts={}) {
            if (rootElem.normalize) {
                rootElem.normalize();
            }

            for (let i = rootElem.childNodes.length - 1; i &gt;= 0; i--) {
                let childNode = rootElem.childNodes[i];

                if (childNode.nodeName === &apos;BR&apos;) {
                    continue;
                }

                if (opts.recursive &amp;&amp; childNode.childNodes.length) {
                    this.removeEmptyNodes(childNode, { recursive: true, rootIsChild: true });
                }

                if (!/[\w\.,\/#!$%\^&amp;\*;:{}=\-_`~()\&apos;\&quot;]/.test(childNode.textContent)) {
                    if (
                        (!opts.rootIsChild &amp;&amp; !zeroWidthSpace.assert(childNode) &amp;&amp; i &gt; 0) ||
                        childNode.nodeType === Node.ELEMENT_NODE
                    ) {
                        DOM.removeNode(childNode);
                    }
                }
            }
        },

        removeStyledSpans (rootElem) {
            const styledSpans = rootElem.querySelectorAll(&apos;span[style]&apos;);
            for (let i = styledSpans.length - 1; i &gt;= 0; i--) {
                let styledSpan = styledSpans[i];
                while (styledSpan.firstChild) {
                    DOM.insertBefore(styledSpan.firstChild, styledSpan);
                }
                DOM.removeNode(styledSpan);
            }
        },

        removeFontNodes (rootElem) {
            const fontTags = rootElem.querySelectorAll(&apos;font&apos;);
            for (let i = fontTags.length - 1; i &gt;= 0; i--) {
                let fontTag = fontTags[i];
                while (fontTag.firstChild) {
                    DOM.insertBefore(fontTag.firstChild, fontTag);
                }
                DOM.removeNode(fontTag);
            }
        }
    }
});

export default BaseFormatter;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>

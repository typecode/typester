<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">scripts/modules/Toolbar.js | typester</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Typester">Typester</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#config">config</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-formatters">formatters</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Toolbar">Toolbar</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#containers">containers</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AppContainer">AppContainer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CanvasContainer">CanvasContainer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-FormatterContainer">FormatterContainer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-UIContainer">UIContainer</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core">core</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Container">Container</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Context">Context</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Mediator">Mediator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Module">Module</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules">modules</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BaseFormatter">BaseFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BlockFormatter">BlockFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Canvas">Canvas</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ContentEditable">ContentEditable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Flyout">Flyout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Formatter">Formatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LinkFormatter">LinkFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ListFormatter">ListFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Mouse">Mouse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Paste">Paste</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Selection">Selection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TextFormatter">TextFormatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Toolbar">Toolbar</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-guid">guid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DOM">DOM</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-browser">browser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-commands">commands</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-func">func</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-keycodes">keycodes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-pasteUtils">pasteUtils</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-zeroWidthSpace">zeroWidthSpace</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">scripts/modules/Toolbar.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// jshint strict: false
import Module from &apos;../core/Module&apos;;
import DOM from &apos;../utils/DOM&apos;;
import toolbarConfig from &apos;../config/toolbar&apos;;

import toolbarTemplate from &apos;../../templates/toolbar.html&apos;;
import toolbarStyles from &apos;../../styles/toolbar.scss&apos;;

/**
* @access protected
*/
const Toolbar = Module({
    name: &apos;Toolbar&apos;,
    dom: {
        &apos;toolbarMenuItems&apos;: &apos;.typester-menu-item&apos;
    },
    props: {
        el: null,
        styles: null,
        mouseover: 0,
        classNames: {
            MENU_ITEM: &apos;typester-menu-item&apos;,
            ACTIVE: &apos;s--active&apos;
        }
    },
    handlers: {
        commands: {
            &apos;toolbar:hide&apos; : &apos;hideToolbar&apos;,
            &apos;toolbar:set:buttons&apos; : &apos;setButtons&apos;
        },
        events: {
            // &apos;contenteditable:focus&apos;: &apos;showToolbar&apos;,
            &apos;app:destroy&apos; : &apos;destroy&apos;,
            &apos;selection:update&apos; : &apos;handleSelectionChange&apos;,
            // &apos;selection:start&apos; : &apos;handleSelectStart&apos;,
            &apos;selection:change&apos; : &apos;handleSelectionChange&apos;,
            &apos;mouse:down&apos;: &apos;handleMouseDown&apos;,
            &apos;mouse:up&apos;: &apos;handleMouseUp&apos;,
            &apos;import:from:canvas:complete&apos; : &apos;handleCanvasImport&apos;
        },
        domEvents: {
            &apos;click&apos; : &apos;handleToolbarClick&apos;,
            &apos;mouseover&apos; : &apos;handleMouseOver&apos;,
            &apos;mouseout&apos; : &apos;handleMouseOut&apos;
        }
    },
    methods: {
        setup () {
            this.appendStyles();
            this.render();
        },

        init () {
            this.updateToolbarState();
        },

        appendStyles () {
            const { props } = this;
            props.styles = DOM.addStyles(toolbarStyles);
        },

        render () {
            const { mediator, props } = this;
            const buttonConfigs = this.getButtonConfigs();
            const wrapperEl = document.createElement(&apos;div&apos;);

            let toolbarHTML = toolbarTemplate(buttonConfigs);

            if (typeof toolbarHTML === &apos;string&apos;) {
                wrapperEl.innerHTML = toolbarHTML;
            } else {
                wrapperEl.appendChild(toolbarHTML[0]);
            }

            const toolbarEl = wrapperEl.childNodes[0];
            props.flyout = props.flyout || mediator.get(&apos;flyout:new&apos;);
            props.flyout.clearContent();
            props.flyout.show();
            props.flyout.appendContent(wrapperEl.childNodes[0]);

            return toolbarEl;
        },

        getButtonConfigs () {
            const { mediator } = this;
            const contentEditableButtons = mediator.get(&apos;contenteditable:toolbar:buttons&apos;) || [];
            const configButtons = contentEditableButtons.length ? contentEditableButtons : toolbarConfig.buttons;

            let buttons = [];

            configButtons.forEach((configKey) =&gt; {
                // NB This needs to be looked at
                if (configKey === &apos;anchor&apos;) {
                    configKey = &apos;link&apos;;
                }
                const buttonConfig = Object.assign({ configKey }, toolbarConfig.buttonConfigs[configKey]);
                buttons.push(buttonConfig);
            });

            return { buttons };
        },

        handleToolbarClick (evnt) {
            const { mediator, props } = this;
            mediator.exec(&apos;contenteditable:refocus&apos;);
            mediator.exec(&apos;selection:reselect&apos;);

            const menuItemEl = DOM.getClosest(evnt.target, `.${props.classNames.MENU_ITEM}`);
            const { dataset } = menuItemEl;
            const { configKey } = dataset;
            const buttonConfig = toolbarConfig.buttonConfigs[configKey];
            const { formatter, opts } = buttonConfig;
            const toolbarMenuItemState = this.getMenuItemState(menuItemEl);

            opts.toggle = buttonConfig.toggles &amp;&amp; toolbarMenuItemState.isActive;
            mediator.exec(`format:${formatter}`, opts);
        },

        // handleSelectStart () {
        //     this.hideToolbar();
        // },

        handleSelectionChange () {
            const { props } = this;
            if (props.selectionChangeTimeout) {
                clearTimeout(props.selectionChangeTimeout);
            }
            props.selectionChangeTimeout = setTimeout(() =&gt; {
                this.updateToolbarState();
            }, 10);
        },

        handleMouseDown () {
            this.updateToolbarState();
        },

        handleMouseUp () {
            this.updateToolbarState();
        },

        handleMouseOver () {
            const { props } = this;
            props.mouseover += 1;
            props.mouseover = Math.min(1, props.mouseover);
        },

        handleMouseOut () {
            const { props } = this;
            props.mouseover -= 1;
            props.mouseover = Math.max(0, props.mouseover);
        },

        handleCanvasImport () {
            this.updateToolbarState();
        },

        hideToolbar () {
            const { props } = this;
            props.flyout.hide();
        },

        showToolbar () {
            this.render();
        },

        positionToolbar () {
            const { mediator, props } = this;
            const selectionBounds = mediator.get(&apos;selection:bounds&apos;);

            if (selectionBounds.initialWidth &gt; 0) {
                const scrollOffset = DOM.getScrollOffset();
                const docRelTop = selectionBounds.top + scrollOffset.y;
                const docRelLeft = selectionBounds.initialLeft + scrollOffset.x;
                const docRelCenter = selectionBounds.initialWidth / 2 + docRelLeft;

                props.flyout.position({
                    left: docRelCenter + &apos;px&apos;,
                    top: docRelTop + &apos;px&apos;
                });
            }
        },

        updateToolbarState () {
            const { mediator, props } = this;
            const currentSelection = mediator.get(&apos;selection:current&apos;);
            const linkFormatterActive = mediator.get(&apos;format:link:active&apos;);
            const mouseIsDown = mediator.get(&apos;mouse:is:down&apos;);

            if (
                !currentSelection ||
                currentSelection.isCollapsed ||
                !currentSelection.toString().trim().length ||
                linkFormatterActive ||
                !document.activeElement.hasAttribute(&apos;contenteditable&apos;) ||
                mouseIsDown
            ) {
                if (props.mouseover) {
                    return;
                }
                this.hideToolbar();
            } else {
                this.positionToolbar();
                this.showToolbar();
                this.updateMenuItems();
            }
        },

        updateMenuItems () {
            const { dom, mediator } = this;
            mediator.exec(&apos;selection:ensure:text:only&apos;);
            for (let i = 0; i &lt; dom.toolbarMenuItems.length; i++) {
                let toolbarMenuItem = dom.toolbarMenuItems[i];
                this.updateMenuItemState(toolbarMenuItem);
            }
        },

        updateMenuItemState (toolbarMenuItem) {
            const { props } = this;
            const toolbarMenuItemState = this.getMenuItemState(toolbarMenuItem);

            if (toolbarMenuItemState.isDisabled) {
                toolbarMenuItem.setAttribute(&apos;disabled&apos;, &apos;&apos;);
            } else {
                toolbarMenuItem.removeAttribute(&apos;disabled&apos;);
            }

            DOM.toggleClass(toolbarMenuItem, props.classNames.ACTIVE, toolbarMenuItemState.isActive);
        },

        getMenuItemState (toolbarMenuItem) {
            const { mediator } = this;
            const { configKey } = toolbarMenuItem.dataset;

            const config = toolbarConfig.buttonConfigs[configKey];

            const activeIn = config.activeIn || [];
            const disabledIn = config.disabledIn || [];
            const isActive = mediator.get(&apos;selection:in:or:contains&apos;, activeIn);

            let isDisabled = false;
            if (typeof disabledIn === &apos;function&apos;) {
                isDisabled = disabledIn.call(config, mediator);
            } else {
                isDisabled = mediator.get(&apos;selection:in:or:contains&apos;, disabledIn);
            }

            return {
                isActive,
                isDisabled
            };
        },

        destroy () {
            const { props } = this;
            props.flyout.remove();
        }
    }
});

export default Toolbar;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
